<!doctype html><html lang=ru-ru><head><meta charset=utf-8><title>Тесты производительности прототипа Heeus, ноябрь 2020</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=description content="Тесты производительности Heeus, ноябрь 2020. Сравнение с эталонным приложением"><meta name=generator content="Hugo 0.82.1"><link rel=stylesheet href=https://heeus.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://heeus.io/plugins/themify-icons/themify-icons.css><link rel=stylesheet href=https://heeus.io/plugins/magnific-popup/magnific-popup.css><link rel=stylesheet href=https://heeus.io/plugins/slick/slick.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Anaheim%7cQuattrocento+Sans:400,700&display=swap"><link rel=stylesheet href=https://heeus.io/css/style.min.css media=screen><link rel=stylesheet href=https://heeus.io/css/custom.min.css media=screen><link rel="shortcut icon" href=https://heeus.io/images/favicon.png type=image/x-icon><link rel=icon href=https://heeus.io/images/favicon.png type=image/x-icon><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=PT+Sans&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap" rel=stylesheet><script async src="https://www.googletagmanager.com/gtag/js?id=G-W113C1YZYH"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-W113C1YZYH')</script></head><body id=body data-spy=scroll data-target=.navbar data-offset=55><div id=content><section class="sticky-top navigation"><div class=container><nav class="navbar navbar-expand-lg navbar-dark"><a class="navbar-brand p-0" href=/ru><img class=lozad data-src=https://heeus.io/images/logo.png alt="Heeus - Платформа облачных приложений" height=42></a>
<button class="navbar-toggler rounded-0" type=button data-toggle=collapse data-target=#navigation>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=https://heeus.io/ru/></a></li></ul><select id=select-language onchange="location=this.value"><option id=en value=https://heeus.io/blog/performance-202011/>En</option><option id=ru value=https://heeus.io/ru/blog/performance-202011/ selected>Ru</option></select></div></nav></div></section><section class=section><div class=container><div class=row><div class="col-lg-8 offset-lg-2 text-center"><h1>Тесты производительности прототипа Heeus, ноябрь 2020</h1><ul class="list-inline mb-50"><li>Михаил Сайгаченко, Heeus Team</li><li>13.11.2020</li></ul><div class=post-img-row><div class="post-img mb-50"><img class="img-fluid lozad" data-src=https://heeus.io/images/blog/performance-1.png alt=blog-image></div></div></div><div class="col-lg-8 offset-lg-2"><div class=post-single-content><h2 id=вступление>Вступление</h2><p>В данной статье будут приведены некоторые подробности подготовки, описание методики и обобщенные результаты тестирования производительности операций вставки, чтения и обновления в БД с применением приложения на платформе Heeus, и сравнения показателей с т.н. &ldquo;эталонным&rdquo; приложением. В качестве СУБД мы использовали <a href=https://cassandra.apache.org>Apache Cassandra</a>.</p><h2 id=эталонное-приложение>Эталонное приложение</h2><p>Для целей тестирования мы написали приложение на языке Go, принимающее http запросы на вставку, чтение или обновление в JSON формате, выполняющее операцию и возвращающее ответ. Веб-сервер основан на встроенной net/http библиотеке. Никакой другой логики или журналирования приложение не осуществляет. В кластере запускается два экземпляра приложения, в качестве балансировщика нагрузки используется Nginx.</p><h2 id=приложение-heeus>Приложение Heeus</h2><p>Приложение Heeus, будучи написано и скомпилировано с использованием фреймворка Heeus, выполняет те же операции (вставка, чтение или обновление), работает с той же СУБД.</p><p>Heeus имеет собственный балансировщик, поэтому параллельно с nginx на бастион устанавливается роутер Heeus.</p><h2 id=инфраструктура>Инфраструктура</h2><p>К моменту тестирования у нас уже был готов инструмент для автоматического построения инфраструктуры кластера на основе метаинформации: структуре, функциях, характеристиках. Если кратко, то инструмент генерирует набор Terraform файлов, в <a href=https://aws.amazon.com/>Amazon AWS</a> формируется инфраструктура: публичная сеть и приватные сети для каждого датацентра (в рамках тестирования мы ограничивались одним), инстансы (узлы) требуемой конфигурации. Затем на созданные узлы устанавливается необходимое ПО и запускаются тесты. Виды узлов кластера следующие:</p><ul><li>В публичной подсети:<ul><li>бастион (он же: роутер, балансировщик);</li><li>тестовый стенд - на котором запускается приложение, бомбардирующее роутер запросами;</li></ul></li><li>В приватных подсетях:<ul><li>БД;</li><li>рабочий узел (инстанс, на котором выполняются сервисы).</li></ul></li></ul><p>Во всех тестах, приведенных в этой статье, используется 3 инстанса <a href="https://aws.amazon.com/ec2/instance-types/?nc1=h_ls">i3.xlarge</a> для размещения серверов Cassandra. Файлы БД размещаются на NVMe SSD. Replication Factor составляет 3, Consistency Level - 2. Типы и количество всех видов инстансов для каждого конкретного теста будут приведены ниже. В качестве ОС на всех узлах использовалась Ubuntu 18.04 (образ ami-0b7937aeb16a7eb94: ubuntu-bionic-18.04-amd64-server-20200112).</p><h2 id=методика-тестирования>Методика тестирования</h2><p>На тестовом стенде запускается серия тестов. Каждый тест представляет собой имитацию нагрузки разной степени на систему. Степени нагрузки задаются количеством атакующих потоков: 40, 60, 100, 150, 250, 400, 600, 900, 1200, 1800. Балансировщик атакуется на протяжении некоторого времени, в течение которого собираются различные показатели работы системы: производительность (операций в секунду), время отклика (latency), загрузка ЦП всех узлов и прочее.</p><p>Первоначально мы планировали тестировать с использованием пакета <a href=https://github.com/brianfrankcooper/YCSB>YCSB</a>. Но, поработав с ним некоторое время, отказались от него в пользу своего инструмента, написанного на Go. Основными аргументами в пользу этого стали: а) YCSB требует JVM, процесс его разворачивания и запуска не так легок и быстр как хотелось бы; б) это оказалось для нас неожиданностью, но YCSB имеет недостаточную для наших тестов производительность. Была написана своя утилита, работающая похожим образом, но не такая нагруженная не нужными нам функциями.</p><h3 id=особенности-тестирования>Особенности тестирования</h3><ul><li>Эталонное приложение и Heeus работают с разными keyspace БД</li><li>Тест на вставку: запись в БД 500 000 записей с уникальными ключами. Данные в каждом пакете - около 1 Кб.</li><li>Перед тестами на чтение и обновление осуществляется вставка 500 000 записей, на базе которых затем выполняются тесты</li><li>Heeus &ldquo;из коробки&rdquo; обеспечивает высокую согласованность данных при операциях обновления. Поскольку сравнивать такие операции с простыми CQL UPDATE в Cassandra было бы некорректно, то в эталонном приложении реализовано обновление с помощью <a href=https://docs.datastax.com/en/archived/cql/3.3/cql/cql_using/useInsertLWT.html>LWT транзакций</a>: <code>UPDATE ... IF ...</code>.</li></ul><h3 id=интерпретация-результатов>Интерпретация результатов</h3><ul><li>Все числовые показатели были собраны, обработаны, и представлены в виде графиков для удобства</li><li>При расчете производительности в зачёт идут только операции, завершившиеся успешно</li><li>В качестве показателя загрузки ЦП узла приведены средние значения загрузки всех узлов данного вида (например, рабочих узлов) на протяжении всего теста</li></ul><h2 id=результаты-вставка>Результаты: вставка</h2><p>Узлы кластера:</p><table><thead><tr><th>Узел</th><th>Количество</th><th>Тип инстанса AWS</th></tr></thead><tbody><tr><td>бастион</td><td>1</td><td>c5.2xlarge</td></tr><tr><td>тестовый стенд</td><td>1</td><td>c5.2xlarge</td></tr><tr><td>рабочий узел</td><td>2</td><td>c5.xlarge</td></tr><tr><td>БД</td><td>3</td><td>i3.xlarge</td></tr></tbody></table><p><img src=/ru/images/blog/performance-202011/insert/rps.jpg alt="Тест производительности вставки: количество операций в секунду">
Рис. 1: Тест производительности вставки: количество операций в секунду</p><p><img src=/ru/images/blog/performance-202011/insert/latency.jpg alt="Тест производительности вставки: время отклика">
Рис. 2: Тест производительности вставки: время отклика</p><p>Видно, что на низких нагрузках показатели Heeus и эталонного приложения примерно равны, но по мере увеличения количества атакующих преимущество Heeus растет. Это относится и к количеству операций в секунду, и к времени отклика. Вот показатели средней загрузки ЦП на узлы кластера:</p><p><img src=/ru/images/blog/performance-202011/insert/db_cpu.jpg alt="Тест производительности вставки: загрузка ЦП БД">
Рис. 3: Тест производительности вставки: загрузка ЦП БД</p><p><img src=/ru/images/blog/performance-202011/insert/router_cpu.jpg alt="Тест производительности вставки: загрузка ЦП роутера">
Рис. 4: Тест производительности вставки: загрузка ЦП роутера</p><p>Балансировщик Heeus загружает ЦП несколько больше - 16% против 10% у эталонного. Зато обрабатывает почти в три раза больше запросов!</p><p><img src=/ru/images/blog/performance-202011/insert/worker_cpu.jpg alt="Тест производительности вставки: загрузка ЦП рабочих узлов">
Рис. 5: Тест производительности вставки: загрузка ЦП рабочих узлов</p><p>Heeus обрабатывает существенно большее количество операций в секунду, но уровни загрузки рабочих узлов примерно такие же, как у эталонного приложения.</p><h2 id=результаты-обновление>Результаты: обновление</h2><p>Узлы кластера:</p><table><thead><tr><th>Узел</th><th>Количество</th><th>Тип инстанса AWS</th></tr></thead><tbody><tr><td>бастион</td><td>1</td><td>c5.2xlarge</td></tr><tr><td>тестовый стенд</td><td>1</td><td>c5.2xlarge</td></tr><tr><td>рабочий узел</td><td>2</td><td>c5.xlarge</td></tr><tr><td>БД</td><td>3</td><td>i3.xlarge</td></tr></tbody></table><p><img src=/ru/images/blog/performance-202011/update/rps_1.jpg alt="Тест производительности обновления: количество операций в секунду">
Рис. 6: Тест производительности обновления: количество операций в секунду</p><p><img src=/ru/images/blog/performance-202011/update/latency_1.jpg alt="Тест производительности обновления: время отклика">
Рис. 7: Тест производительности обновления: время отклика</p><p>На графиках выше понятна разница, но конкретные цифры не просматриваются. Поэтому вот те же графики, но с логарифмической шкалой по вертикали и ярлыками данных:</p><p><img src=/ru/images/blog/performance-202011/update/rps_2.jpg alt="Тест производительности обновления: количество операций в секунду">
Рис. 8: Тест производительности обновления: количество операций в секунду</p><p><img src=/ru/images/blog/performance-202011/update/latency_2.jpg alt="Тест производительности обновления: время отклика">
Рис. 9: Тест производительности обновления: время отклика</p><p>Видно, насколько плохо становится эталонному приложению при увеличении количества атакующих потоков на тестовом стене. Если бы не LWT, показатели были бы примерно как в предыдущем тесте. Но, повторюсь, Heeus при обновлении также обеспечивает высокую согласованность.
Показатели средней загрузки ЦП на узлы кластера:</p><p><img src=/ru/images/blog/performance-202011/update/db_cpu.jpg alt="Тест производительности обновления: загрузка ЦП БД">
Рис. 10: Тест производительности обновления: загрузка ЦП БД</p><p><img src=/ru/images/blog/performance-202011/update/router_cpu.jpg alt="Тест производительности обновления: загрузка ЦП роутера">
Рис. 11: Тест производительности обновления: загрузка ЦП роутера</p><p><img src=/ru/images/blog/performance-202011/update/worker_cpu.jpg alt="Тест производительности обновления: загрузка ЦП рабочих узлов">
Рис. 12: Тест производительности обновления: загрузка ЦП рабочих узлов</p><h2 id=результаты-чтение>Результаты: чтение</h2><p>Узлы кластера:</p><table><thead><tr><th>Узел</th><th>Количество</th><th>Тип инстанса AWS</th></tr></thead><tbody><tr><td>бастион</td><td>1</td><td>c5.4xlarge</td></tr><tr><td>тестовый стенд</td><td>1</td><td>c5.4xlarge</td></tr><tr><td>рабочий узел</td><td>2</td><td>c5.4xlarge</td></tr><tr><td>БД</td><td>3</td><td>i3.xlarge</td></tr></tbody></table><p><img src=/ru/images/blog/performance-202011/read/rps.jpg alt="Тест производительности чтения: количество операций в секунду">
Рис. 13: Тест производительности чтения: количество операций в секунду</p><p><img src=/ru/images/blog/performance-202011/read/latency.jpg alt="Тест производительности чтения: время отклика">
Рис. 14: Тест производительности чтения: время отклика</p><p>Огромное преимущество Heeus объясняется, в том числе, встроенным кешированием &ldquo;из-коробки&rdquo;. Посмотрите на графики загрузки ЦП узлов кластера:</p><p><img src=/ru/images/blog/performance-202011/read/db_cpu.jpg alt="Тест производительности чтения: загрузка ЦП БД">
Рис. 15: Тест производительности чтения: загрузка ЦП БД</p><p><img src=/ru/images/blog/performance-202011/read/router_cpu.jpg alt="Тест производительности чтения: загрузка ЦП роутера">
Рис. 16: Тест производительности чтения: загрузка ЦП роутера</p><p><img src=/ru/images/blog/performance-202011/read/worker_cpu.jpg alt="Тест производительности чтения: загрузка ЦП рабочих узлов">
Рис. 17: Тест производительности чтения: загрузка ЦП рабочих узлов</p><p>Из графика средней загрузки ЦП узов БД как раз видно, что на протяжении первых нескольких тестов кеш &ldquo;прогревается&rdquo;, далее загрузка ЦП снижается вплоть до полного отсутствия необходимости чтения из БД.</p><h2 id=заключение>Заключение</h2><p>Можно сказать, что на данном этапе показатели производительности Heeus значительно превышают показатели эталонного приложения. За счет эффективной архитектуры и оптимизаций производительности Heeus уже &ldquo;из коробки&rdquo; предоставляет возможности High Load для облачных приложений.</p></div><div class=text-center><a class="btn btn-transparent" href=javascript:history.back()>Назад</a></div><div class=mt-5></div></div></div></div></section></div><footer id=footer class=section-bg><div class=container><div class="row wow fadeInUp" data-wow-duration=500ms><div class=col-xl-12><div class="copyright text-center"><a href=https://heeus.io/ru/><img src=https://heeus.io/images/logo.png alt="Heeus - Платформа облачных приложений" height=42></a><br><p>Copyright © 2020-2021 Heeus Authors</p></div></div></div></div></footer><script src=https://heeus.io/plugins/jquery/jquery.min.js></script><script src=https://heeus.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://heeus.io/plugins/slick/slick.min.js></script><script src=https://heeus.io/plugins/shuffle/shuffle.min.js></script><script src=https://heeus.io/plugins/magnific-popup/jquery.magnific-popup.min.js></script><script src=https://heeus.io/plugins/lazy-load/lozad.min.js></script><script src=https://heeus.io/plugins/google-map/map.js></script><script src=https://heeus.io/js/script.min.dfda07d67e5db1f94983c10b2d63fffe981b4255494e79874f525fe100789ebb633dfc9a4d787ca1cae962ef83ea91d5.js integrity=sha384-39oH1n5dsflJg8ELLWP//pgbQlVJTnmHT1Jf4QB4nrtjPfyaTXh8ocrpYu+D6pHV></script></body></html>